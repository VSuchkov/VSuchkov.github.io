define("js2/CommentsExtended",["jquery","./Observable","underscore","./misc"],function(e,t,n){return function(o,a){"use strict";var i=document.location.href.split("#")[1]||"",r={};i.length>0&&(i=i.split("-"),2==i.length?("answer"==i[0]&&(r.action=i[0]),24==i[1].length&&(r.comment_id=i[1])):1==i.length&&0==i[0].indexOf("comment")&&24==i[0].replace("comment","").length&&(r.comment_id=i[0]));var s=e(o),d=this;n.extend(d,new t),!function(){if(s.data("ownerTypes")&&s.data("ownerId")){var o=new function(o){var i=this,m=o.data("sort")||"default",c=+o.data("count")||0,l=+o.data("skip")||0,u=+o.data("onpage")||0,p=+o.data("burst")||0,f=o.data("snippet")||"";n.extend(i,new t),i.load=function(){var t;return function(n,o){var r;t&&t.abort&&t.abort(),n&&n!==m&&(m=n,o=!0),o&&(l=0),r=i.limit(),i.trigger("before.load");var u={area:"service",action:"CommentList",owner:s.data("ownerTypes"),organization:s.data("ownerId"),seo_target_type:s.data("seoTargetType"),is_widget:s.data("isWidget"),snippet:f,sort:m,limit:r,skip:l,strategy:s.data("strategy"),strategy_options:a};return t=e.get("/js.php",u).done(function(e){e.success&&(i.trigger("load",e.list,o),l+=r,c=e.count,d.trigger("remain",c-l))}).always(function(){i.trigger("after.load")}),i}}(),i.reload=function(){var e=l;return u+=e,i.load(null,!0),u-=e,i},i.remain=function(){return c-l},i.limit=function(){return c>l+u+p?u:c-l},i.on("load",function(t,n){if(o[n?"html":"append"](t),lazyload(o),e(window).trigger("height"),r.hasOwnProperty("comment_id")){var a=o.find("#comment"+r.comment_id);if(!a.length)return;e(window).scrollTop(a.offset().top),r.hasOwnProperty("action")&&"answer"==r.action&&a.find(".comment-container .js-comment-reply:first").trigger("click")}}),i.on("clear",function(){o.empty()}),i.setSnippet=function(e){f=e,i.reload()}}(e(".js-comment-list",s)),i=new function(e){var o=this,a=e.siblings(".js-loader");n.extend(o,new t),e.on("click",function(t){t.preventDefault(),e.attr("disabled")||o.trigger("click")}),o.loaderShow=function(){a.show(),e.attr("disabled",!0).addClass("disabled")},o.loaderHide=function(){a.hide(),e.attr("disabled",!1).removeClass("disabled")},o.remain=function(t,n){var o;return t<=0?void e.closest(".js-show-more-box").hide():(o="Показать ещё ",o+=t>n?n+" из "+t+" "+plural(t,"отзывов","отзыва","отзывов"):t+" "+plural(t,"отзывов","отзыв","отзыва"),void e.show().text(o).closest(".js-show-more-box").show())}}(e(".js-show-more",s)),m=new function(o){var a=this;n.extend(a,new t),e(".js-order-switch",o).on("change",function(){e(this).closest("label").addClass("active").siblings().removeClass("active"),a.trigger("change",this.value)})}(e(".js-order-controls",s)),c=new function(o){var a=this;n.extend(a,new t),a.set=function(t,n){n||(n=e('.js-snippet[data-snippet="'+t+'"]').data("title")||t),o[t?"show":"hide"](),o.find(".title").text(n),a.trigger("change",t)},a.getFromHash=function(){var e=window.location.hash.substring(1),t=/snippet=([а-я]+)/i,n=e.match(t);if(e&&n)return n[1]?n[1]:""},o.on("click",".close",function(e){e.preventDefault(),a.set("")}),e(window).on("snippet",function(e,t,n){t&&a.set(t,n)})}(e(".js-filter-snippet",s));c.on("change",function(t){var n=s.offset().top;window.offsetTop&&(n-=window.offsetTop),e("html, body").animate({scrollTop:n},300);var a=window.location.pathname;t&&(a+="#snippet="+t),window.history.pushState&&window.history.pushState(null,"",a),o.setSnippet(t)});var l=c.getFromHash();l&&c.set(l),o.on("before.load",i.loaderShow),o.on("after.load",i.loaderHide),m.on("change",o.load),i.on("click",function(t){return function(){t?(--t,o.reload(),e(window).trigger("track-event",["service","reviews"])):o.load()}}(+s.data("reloadFirst")||0)),r.hasOwnProperty("comment_id")&&i.trigger("click"),d.on("remain",function(e){i.remain(e,o.limit())}),i.remain(o.remain(),o.limit())}}(),!function(){s.on("click",".js-comment-show-full",function(t){t.preventDefault();var n=e(this).closest(".js-comment-text").next(".js-comment-full-text");e(this).closest(".js-comment-text").html(n.html()),n.remove(),e(window).trigger("height")})}(),!function(){s.on("click",".js-comment-photos-show-more",function(t){t.preventDefault();var n=e(this),o=e(this).closest(".js-comment"),a=o.find(".js-comment-photos-list:first"),i=n.data("photos");return 1==i?(n.hide(),void a.find(".comment-image-cropped").removeClass("comment-image-cropped")):void e.get("/js.php",{area:"messages",action:"photos",owner_id:o.data("id"),owner_type:o.data("type"),offset:1},function(t){n.hide(),a.append(t),o.find(".js-comment-photos-list-wrapper:first").removeClass("hidden"),a.find(".comment-image-cropped").removeClass("comment-image-cropped"),lazyload(o),e(window).trigger("height")})})}(),!function(){var t={fb:"https://www.facebook.com/sharer/sharer.php?s=100&p[title]={title}&p[summary]={description:550}&p[url]={url}",vk:"https://vk.com/share.php?url={url}&title={title}&description={description:550}&noparse=false",tw:"https://twitter.com/share?url={url}&text={description:550}",ok:"http://www.odnoklassniki.ru/dk?st.cmd=addShare&st.s=1&st._surl={url}&st.comments={description:550}",gp:"https://plus.google.com/share?url={url}"};e(".js-comment-list",s).on("click",".js-share-controls .js-share-button",function(n){var o,a,i=e(this),r=i.closest(".js-comment");n.preventDefault(),(o=t[i.data("counter")])&&(a={url:window.location.href+"#"+r.attr("id"),title:(+r.data("isMy")?"О":r.data("author")+" о")+"ставил"+("F"===r.data("authorGender")?"а":"")+" отзыв "+s.data("shareAbout"),description:r.find(".js-comment-text").text()},o=o.replace(/\{([^{}]*)\}/g,function(e,t){return t=t.split(":"),t.length>1&&(a[t[0]]=a[t[0]].substr(0,t[1])),encodeURIComponent(a[t[0]])||""}),e.post("/js.php",{area:"misc",action:"share",object_type:"comment",object_id:r.data("id"),counter_type:i.data("counter")},function(){var e=i.find("span");e.text((+e.text()||0)+1)}),window.open(o,"open_window","width=626, height=436"))})}(),function(){e(".js-comment-list",s).on("click",".js-comment-complaint",function(t){t.preventDefault();var n=e(this).data("id");create_layer("complaint_comment",{parameters:{id:n}})})}(),function(){var t=s.get(0);t.addEventListener&&t.addEventListener("load",function(t){var n=t.target||t.srcElement;if(n&&"IMG"===n.tagName.toUpperCase()){var o=e(n);o.hasClass("js-no-height")&&(!o.data("original")||o.prop("src")===o.data("original"))&&o.height()>parseInt(o.data("maxHeight"),10)&&o.parent().addClass("comment-image-cropped").removeClass("oh").css("max-height","").closest(".js-comment-photos-list-wrapper").find(".js-comment-photo-limiter").removeClass("hidden")}},!0)}()}}),define("js2/RatingChangeBlock",["jquery","./Observable"],function(e,t){function n(a,i,r,s,d){function m(){c(),w.on("mouseleave."+o,l),j.on("mouseenter."+o,function(){u(e(this).data("pos"))}).on("mouseleave."+o,function(){u(y)}).on("click."+o,function(){var t=+e(this).data("pos"),n=j.index(this);j.removeClass("star-selected").eq(n).addClass("star-selected"),e.post("/js.php",{area:g,action:"mark",id:i,value:t},function(n){var o=this;n.success?(e(window).trigger({type:"rating_change",user_rating:t,total_rating:n.value,total_count:n.count,tooltip:n.tooltip}),f.trigger("ratingChange",t,n.value,n.count),n.liga&&create_layer("liga",{parameters:{comment_id:n.comment_id}})):n.layer&&create_layer("phone_confirm",{parameters:{type:"rating",owner_type:r,owner_id:i},onConfirmed:function(t){e.ajax(o)}}),e(window).trigger("track-event",["rating","send"])})})}function c(){w.off("."+o),j.off("."+o)}function l(){u("total"==d||"user_total"==d?y:s)}function u(t){j.each(function(){var n=p(e(this).data("pos"),t);e(this).find("span").css("width",n+"%").show()})}function p(e,t){var n=1*(100*(t-e+1)).toFixed(1);return n>100?n=100:n<0&&(n=0),n}if(!(this instanceof n))return new n(a,i,r,s,d);var f=this;_.extend(f,new t);var h=a.data(o);if(h)return h;var v=Array.prototype.slice.call(arguments,1),g=r;"organization"===g&&(g="service");var w=e(".stars-view",a),j=e(".star-item",w),y=w.data("val");s=w.data("my")||void 0;var b=!1;f.init=function(){if(a.length)return b?f:(b=!0,"user"!=d&&"user_total"!=d||(m(),w.css("cursor","pointer")),e(window).on("rating_change",function(e){s=e.user_rating,y=e.total_rating,w.attr("title",e.tooltip),w.data("my",s),w.data("val",y),l()}),l(),a.data(o,f),f)},f.destroy=function(){c(),e.removeData(a,o)},f.clone=function(t){e.removeData(t,o),n.apply(null,[e(t)].concat(v)).init()}}var o="RatingChangeBlock";return n.clone=function(t){var n=e(t).data(o);n&&n.clone(t)},n}),define("js2/ParameterArray",[],function(){var e={};return e.set=function(e,t,n){var o=!1,a={name:t,value:n+""},i=_.map(e,function(e){return e.name!=t?e:(o=!0,a)});return o||i.push(a),i},e.has=function(e,t){return _.any(e,function(e){return e.name==t})},e.getAll=function(e,t){var n=_.filter(e,function(e){return e.name==t});return n},e.get=function(e,t,n){var o=_.filter(e,function(e){return e.name==t});return o.length?o[0].value:n},e.remove=function(e,t,n){return"undefined"==typeof n?_.filter(e,function(e){return e.name!=t}):_.filter(e,function(e){return e.name!=t||e.value!=n})},e.removeEmpty=function(e){return _.filter(e,function(e){return""!=e.value})},e.unserialize=function(e){var t=[];try{!function(){for(var n,o=/\+/g,a=/([^&=]+)=?([^&]*)/g,i=function(e){return decodeURIComponent(e.replace(o," "))},r=e;n=a.exec(r);)t.push({name:i(n[1]),value:i(n[2])})}()}catch(e){}return t},e.serialize=function(e){var t=[];for(var n in e){var o=e[n];t.push(encodeURIComponent(o.name)+"="+encodeURIComponent(o.value))}return t.join("&")},e.toHash=function(e,t){var n=t||{};for(var o in e){var a=e[o];n[a.name]=a.value}return n},e.fromHash=function(e){var t=[];for(var n in e)t.push({name:n,value:e[n]});return t},e}),define("js2/CommentForm",["jquery","underscore","./Observable","./Cookie","./RatingChangeBlock","./ParameterArray","./env"],function(e,t,n,o,a,i,r){var s=function(t,n){var n=n||{};this.node=t,this.$node=e(this.node),this.is_authorized=n.is_authorized||!1,this.anonymous=this.$node.data("anonymous")||0,this.is_fileupload_enabled=n.is_fileupload_enabled||!1,this.editable_tracker=!1,this.is_official=n.is_official||!1,this.init()};return s.prototype={init:function(){var t=this;t.$list=e(".js-comment-list",t.node),t.$form=e(".js-comment-form",t.node),t.$loader=e(".js-loader",t.node),t.count=1*t.$list.data("count"),t.initForm(),t.$node.on("click",".js-comment-delete",function(n){n.preventDefault(),t.remove(e(this).closest("li"))}),t.$node.find(".textarea textarea").on("keydown keyup",function(e){e.stopPropagation()}),t.$node.on("click",".js-mark",function(n){n.preventDefault(),t.mark(e(this))}),lazyload(t.node),t.trackEditable(),t.is_authorized?t.postTemp("tempApprove","#reviews"):(o.remove("tmp_comment_id"),o.remove("tmp_comment_token"))},initForm:function(){var t=this;t.$form[0]&&(t.count>0&&(t.$form.hide().closest(".js-comment-form-container").removeClass("hide"),e(window).trigger("height")),t.$form.on("submit.comment",function(e){e.preventDefault(),t.submit(this)}),t.$node.on("click",".js-comment-add",function(n){n.preventDefault(),t.showForm(e(".js-comment-form-container",t.node),e(this),"",""),e(".js-comment-delete",t.$form).addClass("hide")}),t.$node.on("click",".js-comment-reply",function(n){n.preventDefault(),t.showForm(e(this).closest(".js-comment-container"),e(this),e(this).closest("li").data("id")||"",""),e(".js-comment-delete",t.$form).addClass("hide")}),t.$node.on("click",".js-comment-edit",function(n){n.preventDefault(),t.showForm(e(this).closest(".js-comment-container"),e(this),"",e(this).closest("li").data("id")||""),e(".js-comment-delete",t.$form).removeClass("hide")}),t.bindImagesUpload(t.$form))},submit:function(t){var n=this,a=t.length?e(t):n.$form,r=e("textarea",a),s=e.extend(i.toHash(a.serializeArray()),{area:"messages",action:"post"});e.trim(s.content)&&(n.is_authorized||n.anonymous?n.anonymous&&(s.anonymous=1):s.temp=1,e(":submit",a).prop("disabled",!0),n.$loader.show(),e.post("/js.php",s,function(t){var i=this;return t.success?(a.find(".js-comment-image:gt(0)").remove(),a.find("[name=photo_owner_id]").val("").trigger("change"),a.find("[name=photo_owner_type]").val("").trigger("change"),r.val(""),a.hasClass("js-comment-form-cloned")?e("html, body").animate({scrollTop:n.$node.offset().top+"px"},300):(e(".js-comment-reply, .js-comment-add, .js-comment-edit",n.node).removeClass("active"),a.slideUp(function(){e(window).trigger("height")})),!s.id&&s.temp?(n.showAnonymous(),t.liga&&o.set("tmp_comment_layer","liga",3600),o.set("tmp_comment_id",t.message_tmp_id,3600),void o.set("tmp_comment_token",t.message_token,3600)):(t.liga&&create_layer("liga",{parameters:{comment_id:s.id}}),n.appendComment(t),void n.trackEditable())):t.layer?void create_layer("phone_confirm",{parameters:{type:"comments",owner_type:s.owner_type,owner_id:s.owner_id},needAuth:!s.id&&s.temp,onConfirmed:function(){e.ajax(i)}}):(t.censor&&alert("К сожалению, мы не сможем опубликовать этот отзыв. Пожалуйста, переформулируйте его."),void(t.timeout&&alert("К сожалению, время редактирования комментария истекло.")))},"json").done(function(){n.$loader.hide(),e(":submit",a).prop("disabled",!1)}),e(window).trigger("track-event",["message","send"]))},showForm:function(t,n,o,a){var i=this;if(i.$form[0]){if(n.hasClass("active"))return n.removeClass("active"),void i.$form.slideUp(function(){e(window).trigger("height")});e(".js-comment-reply, .js-comment-add, .js-comment-edit",i.node).removeClass("active"),n.addClass("active");var r=function(n,o,a,r){i.$form.removeClass("invalid"),i.$form.slideUp(function(){i.$form.appendTo(t).slideDown(function(){e(window).trigger("height")}),i.$form.find("input[name=parent_id]").val(o);var s=i.$form.find("input[name=id]").val();i.$form.find("input[name=id]").val(n),(n||s)&&(i.$form.find(".js-comment-image:gt(0)").remove(),i.$form.find("[name=photo_owner_id]").val("").trigger("change"),i.$form.find("[name=photo_owner_type]").val("").trigger("change"),i.$form.find("textarea").val(a),i.setPhotos(i.$form,r))})};a?e.post("/js.php",{area:"messages",action:"getPost",id:a},function(e){e.success&&r(a,"",e.content,e.photos||[])},"json"):r("",o,"",[])}},remove:function(t){var n=this,o=t.data("id");if(o){e(".js-comment-delete",n.$form).prop("disabled",!0);var a=e.extend(i.toHash(n.$form.serializeArray()),{area:"messages",action:"delete",id:o});e.post("/js.php",a,function(o){return o.success?(e(".js-comment-delete",n.$form).prop("disabled",!1),void n.$form.slideUp(function(){var o=t.closest(".subcomments");e(".js-comment-form-container",n.node).append(n.$form),t.remove(),n.count--,n.trackEditable(),o.has("li").length||o.addClass("hidden"),e(window).trigger("height")})):void(o.timeout&&alert("К сожалению, время редактирования комментария истекло."))},"json"),e(window).trigger("track-event",["message","delete"])}},trackEditable:function(){var t=this;!t.editable_tracker&&t.$node.has(".js-comment-edit")&&(t.editable_tracker=setInterval(function(){var n=0,o=0;e(".js-comment-edit",t.$node).each(function(){var t=e(this),a=parseInt(t.data("edit-timeout"));if(a--,n++,a<=0)return t.remove(),void o++;t.data("edit-timeout",a);var i=Math.floor(a/86400),r=Math.floor(a/3600%24),s=Math.floor(a/60%60),d=a%60,m="";i>=2?m=i+" д.":i>=1?m=i+" д. "+r+" ч.":r>=1?m=r+" ч. "+s+" мин.":(s=s<10?"0"+s:s,d=d<10?"0"+d:d,m=s+":"+d),e(">span",t).html(m)}),n==o&&(clearInterval(t.editable_tracker),t.editable_tracker=!1)},1e3))},showAnonymous:function(){var t=this;e("body").on("authSuccess.newcomment",function(n,a){var i=o.get("tmp_comment_layer");i&&"liga"==i?a&&(window.location.href=a):t.postTemp("tempApprove",a),e("body").off(".newcomment")}),e("body").on("authFail.newcomment",function(){t.postTemp("tempReject"),e("body").off(".newcomment")}),create_layer("auth",{popstate:r.is_phone,title:"Войдите на Zoon, иначе ваш отзыв будет опубликован как анонимный",parameters:{feedback:!0}})},postTemp:function(t,n){var a=this,i=o.get("tmp_comment_id"),r=o.get("tmp_comment_token"),s=o.get("tmp_comment_layer");i&&r&&e.ajax({cache:!1,dataType:"json",url:"/js.php",type:"get",data:{area:"messages",action:t,id:i,token:r}}).done(function(e){e.success&&(o.remove("tmp_comment_id"),o.remove("tmp_comment_token"),o.remove("tmp_comment_layer"),e.msg_id&&s&&"liga"==s&&create_layer("liga",{parameters:{comment_id:e.msg_id}}),a.appendComment(e,n),a.trackEditable())})},appendComment:function(t,n){var o,a=this,i=e(">li","<div>"+t.message+"</div>");return t.id?(o=e('li[data-id="'+t.id+'"]>.comment-container',a.node),o.children(":not(form)").remove(),o.prepend(e(">.comment-container",i).children()),o.slideDown(),void(a.is_fileupload_enabled&&lazyload(o))):(o=t.parent_id?e('li[data-id="'+t.parent_id+'"]',a.node).find(".js-subcomment-list:first"):a.$list,o.removeClass("hidden"),i.hide().prependTo(o).slideDown(),a.is_fileupload_enabled&&lazyload(o),a.count++,void(n&&(window.location.href=n)))},mark:function(t){var n=t.closest(".js-question"),o=e(".js-mark",n),a=t.data("val");o.removeClass("active"),t.addClass("active"),e.post("/js.php",{area:"messages",action:"mark",id:n.data("id"),value:a},function(e){e.success&&(o.filter("[data-val=1]").find(".mark-text").text(e.mark_sum),o.filter("[data-val=0]").find(".mark-text").text(e.mark_count-e.mark_sum))})},bindImagesUpload:function(t){var n=this;this.is_fileupload_enabled&&!t.hasClass("js-zfileuploader-binded")&&(t.addClass("js-zfileuploader-binded"),require(["zfileuploader"],function(){var o=t.find(".js-comment-images"),a=(o.find(".js-comment-image").eq(0),t.find(".js-comment-images-add-error")),i=t.find(".js-comment-images-add").show();o.find(".js-comment-image:gt(0)").remove(),o.on("click",".js-comment-image-delete",function(o){o.preventDefault();var a=e(this).closest("li");a.hide("fast",function(){e(window).trigger("height")}),e.post("/js.php",{area:"messages",action:"removePhoto",photo_id:a.data("id")},function(){a.remove(),n.checkPhotoCount(t)})});var s={action:"uploadPhoto",area:"messages"};t.find("[name=photo_owner_id]").on("change",function(){s.hasOwnProperty("photo_owner_id")&&delete s.photo_owner_id,this.value&&(s.photo_owner_id=this.value)}),t.find("[name=photo_owner_type]").on("change",function(){s.hasOwnProperty("photo_owner_type")&&delete s.photo_owner_type,this.value&&(s.photo_owner_type=this.value)});var d="Добавить фото...";r.is_phone&&(d='<i class="s-icons-comment-photo"></i>');var m=new qq.ZFileUploader({element:i[0],action:"/js.php",params:s,multiple:!0,maxConnections:1,debug:!1,template:'<div class="qq-uploader" style="display: inline"><div class="qq-upload-drop-area"></div><div class="qq-upload-button iblock middle"><a href="#" onclick="return false;" class="button button-white button-file"><i class="icon-add mg-right-xs s-icons-photo-add-dark"></i><span>'+d+'</span></a></div><ul class="qq-upload-list hidden middle"></ul></div>',onSubmit:function(){n.$loader.show(),e(":submit",t).prop("disabled",!0)},onUpload:function(e,t,n){return s},onComplete:function(o,i,r,s){return t.removeClass("invalid"),m.getInProgress()||(e(":submit",t).prop("disabled",!1),n.$loader.hide()),r.success?void n.setPhotos(t,r.photos||[]):(t.addClass("invalid"),void a.html("Ошибка при загрузке фото"))}})}))},setPhotos:function(t,n){for(var o=t.find(".js-comment-images"),a=o.find(".js-comment-image").eq(0),i=e("<ul />"),r=0;r<n.length;r++){var s=n[r];t.find("[name=photo_owner_id]").val()&&t.find("[name=photo_owner_type]").val()||(t.find("[name=photo_owner_id]").val(s.owner_id).trigger("change"),t.find("[name=photo_owner_type]").val(s.owner_type).trigger("change"));var d=a.clone().removeClass("hide").attr("data-id",s.id);e("img",d).attr("src",s.src),i.append(d)}o.append(i.html()),this.checkPhotoCount(t)},checkPhotoCount:function(t){var n=t.find(".js-comment-images-add"),o=t.find(".js-comment-images");o.find(".js-comment-image:gt(0)").length>=30?n.hide():n.show(),e(window).trigger("height")},getClonedForm:function(){var t=this;return t.$form[0]?(t.$formCloned||(t.$formCloned=t.$form.clone(!0).addClass("js-comment-form-cloned").removeClass("js-zfileuploader-binded"),t.$formCloned.find("input[name=parent_id]").remove(),t.$formCloned.find("textarea").val(""),t.bindImagesUpload(t.$formCloned),a.clone(t.$formCloned.find(".js-user-rating-holder")[0])),t.$formCloned):e([])},showFormBottomOnRemain:function(t){var n=this;t.on("remain",function(t){if(!t){var o=e("<div />",{class:"comment-form-container comment-form-container-bottom"});o.append(n.getClonedForm().show()),o.appendTo(n.node),e(window).trigger("height")}})}},s});